<!DOCTYPE html>

<html>

    <head>
        <title>WellPlotter</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.js"></script>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>

    <body>
        <div id="uploadmenu">
            <input type="file" id="baro" name="baro">
            <input type="file" id="lvllog" name="lvllog[]" multiple="multiple">
            <input type="submit" value="Submit" onclick="processFiles()">
        </div>

        <div id="plots">
        	<svg id="all"></svg>

        </div>


        <script>
        	var files = [];
            function processFiles(){
                var baro = document.getElementById("baro");
                var lvllog = document.getElementById("lvllog");

                files = lvllog.files;

                var formData = new FormData();

                // loop through all the selected files
                for (var i = 0; i < files.length; i++) {
                  var file = files[i];

                  // add the files to formData object for the data payload
                  formData.append('uploads[]', file, file.name);
                }

                formData.append("baro", baro.files[0], baro.files[0].name);

                setTimeout(function(){
                    $.ajax({
                      url: '/upload',
                      type: 'POST',
                      data: formData,
                      processData: false,
                      contentType: false,
                      success: function(data){
                          console.log('upload successful!');
                      }
                    });
                }, 2000);
            }

            function createPlots(){
            	var svg = d3.select("svg#all"),
            	margin = {top: 20, right: 20, bottom: 30, left: 50},
			    width = +svg.attr("width") - margin.left - margin.right,
			    height = +svg.attr("height") - margin.top - margin.bottom,
			    g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");


            	var parseTime = d3.timeParse("%y/%m/%d,%H:%M:%S");

				var x = d3.scaleTime()
				    .rangeRound([0, width]);

				var y = d3.scaleLinear()
				    .rangeRound([height, 0]);

            	var line = d3.line()
            		.x(function(d) {return x(d.date);})
            		.y(function(d) {return y(d.date);});

            	for (var i = 0; i < files.length; i++) {
                  var file = files[i];
                  d3.csv("corrected/" + file.name, function(d){
                  		d.date = parseTime(d.date);
                  		return d;
                  }, function(error, data){
	                  	if(error) throw error;
	                  		x.domain(d3.extent(data, function(d) { return d.date; }));
							y.domain(d3.extent(data, function(d) { return d.close; }));

							g.append("g")
						      .attr("class", "axis axis--x")
						      .attr("transform", "translate(0," + height + ")")
						      .call(d3.axisBottom(x));

							g.append("g")
						      .attr("class", "axis axis--y")
						      .call(d3.axisLeft(y))
						    .append("text")
						      .attr("fill", "#" + i * 150)
						      .attr("transform", "rotate(-90)")
						      .attr("y", 6)
						      .attr("dy", "0.71em")
						      .style("text-anchor", "end")
						      .text("Level (ft)");

							g.append("path")
						      .datum(data)
						      .attr("class", "line")
						      .attr("d", line);
					});
				}
            }
        </script>
    </body>
</html>
