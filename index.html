<!DOCTYPE html>

<html>

    <head>
        <title>WellPlotter</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.js"></script>
        <script src="https://d3js.org/d3.v3.min.js"></script>
        <link href="node_modules/nvd3/build/nv.d3.min.css" rel="stylesheet">
		<script src="node_modules/nvd3/build/nv.d3.min.js"></script>
		<script src="node_modules/nvd3/examples/lib/stream_layers.js"></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>

    <body>
        <div id="uploadmenu">
            <input type="file" id="baro" name="baro">
            <input type="file" id="lvllog" name="lvllog[]" multiple="multiple">
            <input type="submit" value="Submit" onclick="processFiles()">

            <input type="submit" value="Plot" onclick="createPlots()">
        </div>

        <div id="plots">
        	<svg id="all" style="width:600px; height:400px;"></svg>

        </div>


        <script>
        	var files = [];
        	var dat = [];
            function processFiles(){
                var baro = document.getElementById("baro");
                var lvllog = document.getElementById("lvllog");

                files = lvllog.files;

                var formData = new FormData();

                // loop through all the selected files
                for (var i = 0; i < files.length; i++) {
                  var file = files[i];

                  // add the files to formData object for the data payload
                  formData.append('uploads[]', file, file.name);
                }

                formData.append("baro", baro.files[0], baro.files[0].name);

                
                $.ajax({
                  url: '/upload',
                  type: 'POST',
                  data: formData,
                  processData: false,
                  contentType: false,
                  success: function(data){
                      console.log('upload successful!');
                      fetchData();
                      setTimeout(function(){
                      	createPlots();
                      }, 3000);
                  }
                });
                
            }

            function createPlots(){
            	nv.addGraph(function() {
				  var chart = nv.models.lineWithFocusChart();

				  chart.xAxis
				  	.tickFormat(function(d) {
			            return d3.time.format('%x')(new Date(d))
			          });

				  chart.x2Axis
				  	.tickFormat(function(d) {
			            return d3.time.format('%x')(new Date(d))
			          });

				  chart.yAxis
				      .tickFormat(d3.format(',.2f'));

				  chart.y2Axis
				      .tickFormat(d3.format(',.2f'));

				  var data = dat;

				  d3.select('svg#all')
				      .datum(data)
				      .transition().duration(500)
				      .call(chart);

				  nv.utils.windowResize(chart.update);
				  console.log(data);
				  return chart;
				});
            }
            function fetchData(){
				var parseTime = function(d, t){
            		d = d.split("/");

            		t = t.split(":");
            		return new Date(d[0], d[1], d[2], t[0], t[1], t[2]);
            	};
            	$.each(files, function(i, file){	                
	                d3.csv("corrected/"+file.name, function(d){
	               		d.Date = parseTime(d.Date, d.Time);
	               		d.LEVEL = +d.LEVEL;
	               		return d;
	                }, function(error, data){
		               	if(error) throw error;
	                  	data = data.map(function(d){return {x: d.Date, y: d.LEVEL};});
	                  	console.log(data.size());
	                	dat.push({'key': file.name.substring(0, file.name.indexOf(".")), 'values': data});
					});

            	});
			}
        </script>
    </body>
</html>
